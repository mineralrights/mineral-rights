# Cloud Build configuration for deploying to Google Cloud Run
steps:
  # Build the container image
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build', 
      '-f', 'Dockerfile.gcp',
      '-t', 'gcr.io/$PROJECT_ID/mineral-rights-api:$BUILD_ID',
      '.'
    ]

  # Push the container image to Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/mineral-rights-api:$BUILD_ID']

  # Deploy container image to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args: [
      'run', 'deploy', 'mineral-rights-api',
      '--image', 'gcr.io/$PROJECT_ID/mineral-rights-api:$BUILD_ID',
      '--region', 'us-central1',
      '--platform', 'managed',
      '--allow-unauthenticated',
      '--port', '8080',
      '--memory', '2Gi',
      '--cpu', '2',
      '--timeout', '300',
      '--max-instances', '10',
      '--set-env-vars', 'GCS_BUCKET_NAME=mineral-rights-pdfs-1759435410,GOOGLE_CLOUD_PROJECT=$PROJECT_ID,GOOGLE_CLOUD_LOCATION=us-central1,TASK_QUEUE_NAME=mineral-rights-queue,GOOGLE_CREDENTIALS_BASE64=ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAibWluZXJhbC1yaWdodHMtYXBwIiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiMmM5NDQyNGMzYWFiM2Q2OGE4NDA3MmE0Yzk5ODU2ZTIyYTBmMjQwNCIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZRSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2N3Z2dTakFnRUFBb0lCQVFDZG13RndFZWhEMXpCL1xua1ZDZU82OGJFa0ZSbkc4SVovOTlWUGNJcEdYL1libnZ6NlFkbmllWU1oYkptZWN4d2JoS3VWN2FSTStFVnlaTFxubE5Hd0t5dUh2VHhaUy8rQXBhMkV3SFJtbUZGNmdPaDRacHlWTWhlQkxlby83SVZPTnVhY0NKQWsrcjRMTWlBRFxuOGpNa3g4TTltTUtVeWxTQk5henFDbytOZGdxd0hOSXBwdVh2UDhVUjlDL3NnMWZWQ1gzUmJRZXllZkNYSEQ5WFxuTkhOZUxpQ3F4Z01yYVdzaDZsOHI4ODRORStHZzdqVHAwcTNNY080TGNxTmFUbjBtbHh0d01FQm4va254c1pTelxuclU2c2lnbXFUUkJ3eHJ1UG5HaWNGWFJ3a21MQ25zZnp2Y0FGQ0EyWkFjK1FMc0licGJPbStSb0lSSzNOT21OYlxucHFhVmlmU2ZBZ01CQUFFQ2dnRUFFMWhKZldReW9sSnIrVm5iVDRqR09LaEN6STNMSjg0b0V5TldMUmFNdWM0dVxuSzBGMzJmWWwwd01NUHFqb01xTWVCL2RTZ3ErMmhGUEpkMkVvRHh2Rlp6bXkzM0preFU3UXRST0ZxMnJLZVhobFxuZXhNbWsyamN4TFkwNDFnWWtWMzJGclNMQ05iMEhsNEQydjE1WDBHR2RVTG1XS3F3WTZtMGRJZTJVTDAvN2tJY1xubjRrdVJPVk5zQWtycFBMMG1qZ0xnaGN2djBpRmtGUmU0MDBFV3VTUCtYSC9nNmgwcEtUZk0wL0xHNmFDd05YUVxuUm0yZzlQQU1YeXFhZFpDOFF5Q1lHeW1za2hVa1BmazJ6MFpJcXFweEVHVXQzWWwxbGk2ckkrVll0aFBVS0dQTFxuVGVFcllDWDNrNTlVUU40S3Q1UzlsTzN6Z3d0QW41YitWNkR5NnM4cHlRS0JnUURXTlhac2RKVkIycFdSZ3ZvaVxubndOd29yb1QxZkFoK3o4V2NuaUM1WFd2cHlQUklwVGMxVXN0UFcvR0pDcHZyaDlJdjN4TlY5R1k3YXI2MnIvdFxuWU9ubW1IY3lXb3J1ZmIyT1BDNGgvVG9PbWZKeG1zMUwrSDFqRVJUUjFEK0RIc2cwc2ZuekNTWHpmSjUxSm9SdVxuY2FuNXFTWHMrSktibjdxMWM3Tk9DMWdxWndLQmdRQzhXb1YyVk5pTE5EazRNYSs2d3UvYzI3Tkt1aFIzRWZvQlxud1RkSHN4VmsxSjZOaDVwMkxGNFE5aEJJZlFqS01RbmcrMmVwT1pxam9CY3k5SVAvQWY1WElXY3pYblU2MXdqR1xudTlJUmNJT3FxNWNySXhNR0pZYmRYTnpyYS9pQm5RbzRTczNFL3h1WE93aFlUUURpMysvOUlVd2U3OUNzNUN2OVxuSm1XQTQ5OXhDUUtCZ0VYZjFxdDJOQ0h4TFl6enpxaHdlbXpKaUMxa1FocXpuRmEwTEg5MlhqZFlMQ1RTUlFEc1xuU3NPTklPTGZkVUJNNmtPT3d2dHZ4QjFBbWQrT2I4RDlOZzlVZUwxaUw2T3dQSjhqSG1GVCt4WThQWXUxVlhhTVxucmtvY2psQU1EbE8xUE5XRG9PY1lldHE4TWV4QkRqNEFzZE9ReTZCTFRYZWFXUXRMbkplK3Q1bk5Bb0dBZjZlV1xuSnFIUWRWLzZtOVJJOW5uaDJUenBvZTdGcWdGOEFLNTBDZHNjMTg2bWV1TjUwemUwdFNnZjF4RXU0T0lsZ043Q1xuM2RWVnNpbnhMeTY3T3h5ZHhXMjFKUUtTejBNb0JwRUxDWmpKRStYaHVYRzNGZ1pmQmk1RzZDT3dOQ0E3NmZVQVxueXMvZllqcTNLQ2xnUFdOcW9wTnJwTmdDQlB0THVQSEovM1h4WFFrQ2dZRUFrVWdDTnFmS2FhOG9rYVZ4cG9KTVxub0dwNjBzVWtlV0JNZ1ErMnZNb0E0SnlKUE1SbjJnVG9vaklaeXE1QkNvSFY2N1UxZTN2UlRpTVRLT0tCWERidVxuOFZQZzljcklrNW9DVyt4eklqUXp3RFNLVUF1VDIxMGZNTnp0cHcyTW8xS2lHSjRqV3o1c2lTQlo2UTJqZEVqRlxuNmduRmxYMC9VK3lXand1MEVNK2l6VG89XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAibWluZXJhbC1yaWdodHMtc2EtdjJAbWluZXJhbC1yaWdodHMtYXBwLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjExMDM3NDAzNzYxNjA3Nzk3MzYxOSIsCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvbWluZXJhbC1yaWdodHMtc2EtdjIlNDBtaW5lcmFsLXJpZ2h0cy1hcHAuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJ1bml2ZXJzZV9kb21haW4iOiAiZ29vZ2xlYXBpcy5jb20iCn0K',
      '--set-secrets', 'ANTHROPIC_API_KEY=anthropic-api-key:latest'
    ]

  # Build the job worker image
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build', 
      '-f', 'Dockerfile.job',
      '-t', 'gcr.io/$PROJECT_ID/mineral-rights-worker:$BUILD_ID',
      '.'
    ]

  # Push the job worker image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/mineral-rights-worker:$BUILD_ID']

  # Deploy job worker to Cloud Run Jobs
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args: [
      'run', 'jobs', 'deploy', 'mineral-rights-worker',
      '--image', 'gcr.io/$PROJECT_ID/mineral-rights-worker:$BUILD_ID',
      '--region', 'us-central1',
      '--memory', '4Gi',
      '--cpu', '2',
      '--max-retries', '3',
      '--parallelism', '1',
      '--task-timeout', '3600',
      '--set-env-vars', 'GCS_BUCKET_NAME=mineral-rights-pdfs-1759435410,GOOGLE_CLOUD_PROJECT=$PROJECT_ID,GOOGLE_CLOUD_LOCATION=us-central1,DOCUMENT_AI_ENDPOINT=projects/381937358877/locations/us/processors/895767ed7f252878,GOOGLE_CREDENTIALS_BASE64=ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAibWluZXJhbC1yaWdodHMtYXBwIiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiMmM5NDQyNGMzYWFiM2Q2OGE4NDA3MmE0Yzk5ODU2ZTIyYTBmMjQwNCIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZRSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2N3Z2dTakFnRUFBb0lCQVFDZG13RndFZWhEMXpCL1xua1ZDZU82OGJFa0ZSbkc4SVovOTlWUGNJcEdYL1libnZ6NlFkbmllWU1oYkptZWN4d2JoS3VWN2FSTStFVnlaTFxubE5Hd0t5dUh2VHhaUy8rQXBhMkV3SFJtbUZGNmdPaDRacHlWTWhlQkxlby83SVZPTnVhY0NKQWsrcjRMTWlBRFxuOGpNa3g4TTltTUtVeWxTQk5henFDbytOZGdxd0hOSXBwdVh2UDhVUjlDL3NnMWZWQ1gzUmJRZXllZkNYSEQ5WFxuTkhOZUxpQ3F4Z01yYVdzaDZsOHI4ODRORStHZzdqVHAwcTNNY080TGNxTmFUbjBtbHh0d01FQm4va254c1pTelxuclU2c2lnbXFUUkJ3eHJ1UG5HaWNGWFJ3a21MQ25zZnp2Y0FGQ0EyWkFjK1FMc0licGJPbStSb0lSSzNOT21OYlxucHFhVmlmU2ZBZ01CQUFFQ2dnRUFFMWhKZldReW9sSnIrVm5iVDRqR09LaEN6STNMSjg0b0V5TldMUmFNdWM0dVxuSzBGMzJmWWwwd01NUHFqb01xTWVCL2RTZ3ErMmhGUEpkMkVvRHh2Rlp6bXkzM0preFU3UXRST0ZxMnJLZVhobFxuZXhNbWsyamN4TFkwNDFnWWtWMzJGclNMQ05iMEhsNEQydjE1WDBHR2RVTG1XS3F3WTZtMGRJZTJVTDAvN2tJY1xubjRrdVJPVk5zQWtycFBMMG1qZ0xnaGN2djBpRmtGUmU0MDBFV3VTUCtYSC9nNmgwcEtUZk0wL0xHNmFDd05YUVxuUm0yZzlQQU1YeXFhZFpDOFF5Q1lHeW1za2hVa1BmazJ6MFpJcXFweEVHVXQzWWwxbGk2ckkrVll0aFBVS0dQTFxuVGVFcllDWDNrNTlVUU40S3Q1UzlsTzN6Z3d0QW41YitWNkR5NnM4cHlRS0JnUURXTlhac2RKVkIycFdSZ3ZvaVxubndOd29yb1QxZkFoK3o4V2NuaUM1WFd2cHlQUklwVGMxVXN0UFcvR0pDcHZyaDlJdjN4TlY5R1k3YXI2MnIvdFxuWU9ubW1IY3lXb3J1ZmIyT1BDNGgvVG9PbWZKeG1zMUwrSDFqRVJUUjFEK0RIc2cwc2ZuekNTWHpmSjUxSm9SdVxuY2FuNXFTWHMrSktibjdxMWM3Tk9DMWdxWndLQmdRQzhXb1YyVk5pTE5EazRNYSs2d3UvYzI3Tkt1aFIzRWZvQlxud1RkSHN4VmsxSjZOaDVwMkxGNFE5aEJJZlFqS01RbmcrMmVwT1pxam9CY3k5SVAvQWY1WElXY3pYblU2MXdqR1xudTlJUmNJT3FxNWNySXhNR0pZYmRYTnpyYS9pQm5RbzRTczNFL3h1WE93aFlUUURpMysvOUlVd2U3OUNzNUN2OVxuSm1XQTQ5OXhDUUtCZ0VYZjFxdDJOQ0h4TFl6enpxaHdlbXpKaUMxa1FocXpuRmEwTEg5MlhqZFlMQ1RTUlFEc1xuU3NPTklPTGZkVUJNNmtPT3d2dHZ4QjFBbWQrT2I4RDlOZzlVZUwxaUw2T3dQSjhqSG1GVCt4WThQWXUxVlhhTVxucmtvY2psQU1EbE8xUE5XRG9PY1lldHE4TWV4QkRqNEFzZE9ReTZCTFRYZWFXUXRMbkplK3Q1bk5Bb0dBZjZlV1xuSnFIUWRWLzZtOVJJOW5uaDJUenBvZTdGcWdGOEFLNTBDZHNjMTg2bWV1TjUwemUwdFNnZjF4RXU0T0lsZ043Q1xuM2RWVnNpbnhMeTY3T3h5ZHhXMjFKUUtTejBNb0JwRUxDWmpKRStYaHVYRzNGZ1pmQmk1RzZDT3dOQ0E3NmZVQVxueXMvZllqcTNLQ2xnUFdOcW9wTnJwTmdDQlB0THVQSEovM1h4WFFrQ2dZRUFrVWdDTnFmS2FhOG9rYVZ4cG9KTVxub0dwNjBzVWtlV0JNZ1ErMnZNb0E0SnlKUE1SbjJnVG9vaklaeXE1QkNvSFY2N1UxZTN2UlRpTVRLT0tCWERidVxuOFZQZzljcklrNW9DVyt4eklqUXp3RFNLVUF1VDIxMGZNTnp0cHcyTW8xS2lHSjRqV3o1c2lTQlo2UTJqZEVqRlxuNmduRmxYMC9VK3lXand1MEVNK2l6VG89XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAibWluZXJhbC1yaWdodHMtc2EtdjJAbWluZXJhbC1yaWdodHMtYXBwLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjExMDM3NDAzNzYxNjA3Nzk3MzYxOSIsCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvbWluZXJhbC1yaWdodHMtc2EtdjIlNDBtaW5lcmFsLXJpZ2h0cy1hcHAuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJ1bml2ZXJzZV9kb21haW4iOiAiZ29vZ2xlYXBpcy5jb20iCn0K',
      '--set-secrets', 'ANTHROPIC_API_KEY=anthropic-api-key:latest'
    ]

# Store images in Container Registry
images:
  - 'gcr.io/$PROJECT_ID/mineral-rights-api:$BUILD_ID'
  - 'gcr.io/$PROJECT_ID/mineral-rights-worker:$BUILD_ID'

# Build options
options:
  machineType: 'E2_HIGHCPU_8'
  diskSizeGb: 100
