# Migration Scripts

Scripts to help migrate the Mineral Rights app to new Vercel, Google Cloud, and Anthropic accounts.

## Scripts

### `setup_new_gcp_project.sh`

Automates Phase 1 of the migration plan - setting up a new Google Cloud Platform project.

**Usage:**
```bash
./scripts/setup_new_gcp_project.sh NEW_PROJECT_ID NEW_BUCKET_NAME [REGION]
```

**Example:**
```bash
./scripts/setup_new_gcp_project.sh my-mineral-rights-app my-bucket-name us-central1
```

**What it does:**
- Creates a new GCP project
- Enables all required APIs
- Creates a service account with proper permissions
- Generates and base64-encodes service account credentials
- Creates a GCS bucket
- Sets up Secret Manager for Anthropic API key

**Output:**
- `service-account-NEW_PROJECT_ID.json` - Service account key file
- `service-account-NEW_PROJECT_ID.base64.txt` - Base64-encoded credentials

### `migrate_accounts.sh`

Automates Phase 2 of the migration plan - updating configuration files.

**Usage:**
```bash
./scripts/migrate_accounts.sh
```

**Prerequisites:**
1. Create `migration_config.env` in project root (script creates template on first run)
2. Fill in all values in `migration_config.env`

**What it does:**
- Creates backups of all files to be modified
- Updates `cloudbuild.yaml` with new bucket name and Document AI endpoint
- Updates all frontend files with new API URL
- Updates `web/vercel.json` with new API URL

**Note:** You'll need to manually update `GOOGLE_CREDENTIALS_BASE64` in `cloudbuild.yaml` after running this script.

## Migration Config Template

The `migrate_accounts.sh` script creates a `migration_config.env` template on first run. Fill it in with your new account details:

```bash
# Migration Configuration
# Fill in the values below for your new accounts

# Google Cloud Platform
NEW_GCP_PROJECT_ID=your-new-project-id
NEW_GCP_PROJECT_NUMBER=your-project-number
NEW_GCS_BUCKET_NAME=your-new-bucket-name
NEW_DOCUMENT_AI_ENDPOINT=projects/YOUR_PROJECT_NUMBER/locations/us/processors/YOUR_PROCESSOR_ID

# Vercel
NEW_VERCEL_API_URL=https://mineral-rights-api-YOUR_PROJECT_NUMBER.us-central1.run.app

# Anthropic (will be stored in Secret Manager, not here)
# NEW_ANTHROPIC_API_KEY=sk-ant-api03-...

# Service Account (base64 encoded JSON - generate after creating service account)
# NEW_GOOGLE_CREDENTIALS_BASE64=...
```

## Workflow

1. **Setup GCP:**
   ```bash
   ./scripts/setup_new_gcp_project.sh my-project my-bucket
   ```

2. **Create migration config:**
   ```bash
   ./scripts/migrate_accounts.sh
   # Creates migration_config.env template
   ```

3. **Fill in migration_config.env** with values from step 1

4. **Run migration:**
   ```bash
   ./scripts/migrate_accounts.sh
   ```

5. **Manually update** `GOOGLE_CREDENTIALS_BASE64` in `cloudbuild.yaml`

6. **Deploy:**
   ```bash
   gcloud builds submit --config cloudbuild.yaml .
   ```

## Files Modified

The migration script modifies:
- `cloudbuild.yaml`
- `web/vercel.json`
- `web/src/components/ModelManager.tsx`
- `web/src/lib/api_async.ts`
- `web/src/app/page.tsx`
- `web/src/lib/direct_gcs_upload.ts`
- `web/src/lib/gcs_upload.ts`
- `web/src/app/api/get-signed-upload-url/route.ts`
- `web/src/app/api/process-large-pdf-pages/route.ts`
- `web/src/app/api/process-large-pdf/route.ts`

Backups are created in `backups/TIMESTAMP/` directory.

## Troubleshooting

### Script fails with permission errors
- Ensure scripts are executable: `chmod +x scripts/*.sh`
- Check file permissions

### Base64 encoding fails
- Use the `.base64.txt` file generated by `setup_new_gcp_project.sh`
- Or manually: `base64 -i service-account.json | tr -d '\n'`

### Sed errors on macOS
- Script uses `.bak` backups which should work on macOS
- If issues persist, check sed version: `sed --version`

## See Also

- `MIGRATION_GUIDE.md` - Complete migration guide
- `MIGRATION_CHECKLIST.md` - Step-by-step checklist

