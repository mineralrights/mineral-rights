# Migration Guide: Moving to New Accounts

This guide provides step-by-step instructions for migrating the Mineral Rights app to new Vercel, Google Cloud, and Anthropic accounts.

## Quick Start

1. **Run the GCP setup script:**
   ```bash
   ./scripts/setup_new_gcp_project.sh NEW_PROJECT_ID NEW_BUCKET_NAME
   ```

2. **Create migration config:**
   ```bash
   ./scripts/migrate_accounts.sh
   # This will create migration_config.env template on first run
   ```

3. **Fill in `migration_config.env`** with your new account details

4. **Run migration script:**
   ```bash
   ./scripts/migrate_accounts.sh
   ```

5. **Follow the checklist:** See `MIGRATION_CHECKLIST.md`

## Detailed Steps

### Phase 1: Google Cloud Platform Setup

The `setup_new_gcp_project.sh` script automates most of this phase:

```bash
./scripts/setup_new_gcp_project.sh my-new-project-id my-bucket-name
```

This script will:
- Create a new GCP project
- Enable all required APIs
- Create a service account with proper permissions
- Generate and base64-encode service account credentials
- Create a GCS bucket
- Set up Secret Manager for Anthropic API key

**Manual steps required:**
1. Enable billing for the new project (script will prompt)
2. **(OPTIONAL)** Create Document AI processor in Cloud Console (only if you want to use Document AI)
   - Note: The app works fine without Document AI - it uses fallback splitting methods
   - If creating: Note the processor endpoint format

### Phase 2: Configuration Updates

The `migrate_accounts.sh` script handles most file updates:

```bash
./scripts/migrate_accounts.sh
```

**Before running:**
1. Create `migration_config.env` (script creates template on first run)
2. Fill in all values:
   - `NEW_GCP_PROJECT_ID`
   - `NEW_GCP_PROJECT_NUMBER`
   - `NEW_GCS_BUCKET_NAME`
   - `NEW_DOCUMENT_AI_ENDPOINT`
   - `NEW_VERCEL_API_URL`
   - `NEW_GOOGLE_CREDENTIALS_BASE64`

**After running:**
1. Manually update `GOOGLE_CREDENTIALS_BASE64` in `cloudbuild.yaml` (lines 30 and 59)
2. Verify all changes look correct: `git diff`

### Phase 3: Vercel Migration

1. Sign in to new Vercel account
2. Import GitHub repository
3. Create new project
4. Set environment variable:
   - `NEXT_PUBLIC_API_URL` = your new Cloud Run URL
5. Deploy (automatic on push, or manual from dashboard)

### Phase 4: Anthropic Migration

1. Sign in to new Anthropic account
2. Generate new API key
3. Add to Google Secret Manager:
   ```bash
   echo -n "sk-ant-api03-..." | gcloud secrets versions add anthropic-api-key --data-file=-
   ```

### Phase 5: Deploy Backend

```bash
gcloud builds submit --config cloudbuild.yaml .
```

Monitor the build and verify deployment.

### Phase 6: Testing

1. Test frontend: Open Vercel deployment URL
2. Test API: `curl https://mineral-rights-api-NEW_PROJECT_NUMBER.us-central1.run.app/health`
3. Test full workflow: Upload a PDF and verify processing

## Files Modified by Migration Script

The migration script updates these files:

### Backend Configuration
- `cloudbuild.yaml` - GCP deployment configuration

### Frontend Configuration
- `web/vercel.json` - Vercel environment variables
- `web/src/components/ModelManager.tsx` - API URL fallbacks
- `web/src/lib/api_async.ts` - API base URL
- `web/src/app/page.tsx` - API URL fallback
- `web/src/lib/direct_gcs_upload.ts` - API base URL
- `web/src/lib/gcs_upload.ts` - API base URL
- `web/src/app/api/get-signed-upload-url/route.ts` - API base URL
- `web/src/app/api/process-large-pdf-pages/route.ts` - API base URL
- `web/src/app/api/process-large-pdf/route.ts` - API base URL

## Environment Variables

### Google Cloud Run

Set via `cloudbuild.yaml`:
- `ANTHROPIC_API_KEY` - From Secret Manager
- `CLAUDE_MODEL_NAME` - Default: `claude-3-5-haiku-20241022`
- `GCS_BUCKET_NAME` - Your new bucket name
- `GOOGLE_CLOUD_PROJECT` - Your new project ID
- `GOOGLE_CLOUD_LOCATION` - `us-central1`
- `TASK_QUEUE_NAME` - `mineral-rights-queue`
- `GOOGLE_CREDENTIALS_BASE64` - Base64-encoded service account JSON
- `DOCUMENT_AI_ENDPOINT` - Your Document AI processor endpoint (OPTIONAL - app uses fallback if not set)

### Vercel

Set in Vercel dashboard:
- `NEXT_PUBLIC_API_URL` - Your new Cloud Run URL

## Troubleshooting

### Migration Script Issues

**Issue**: Script fails with "migration_config.env not found"
- **Solution**: Run script once to create template, then fill in values

**Issue**: Script fails with sed errors on macOS
- **Solution**: macOS uses different sed syntax. The script uses `.bak` backups which should work.

**Issue**: Base64 encoding fails
- **Solution**: Use the base64 file generated by `setup_new_gcp_project.sh`

### Deployment Issues

**Issue**: Cloud Build fails
- **Solution**: Check Cloud Build service account has required permissions

**Issue**: Frontend can't connect to backend
- **Solution**: Verify `NEXT_PUBLIC_API_URL` in Vercel matches Cloud Run URL

**Issue**: Secret Manager access denied
- **Solution**: Verify service account has `roles/secretmanager.secretAccessor`

### Testing Issues

**Issue**: API returns 404
- **Solution**: Verify Cloud Run service is deployed and URL is correct

**Issue**: Processing fails
- **Solution**: Check Cloud Run logs for errors, verify all environment variables are set

## Rollback Plan

If migration fails:

1. **Keep old accounts active** until new deployment is verified
2. **Revert changes:**
   ```bash
   git checkout HEAD -- cloudbuild.yaml web/vercel.json web/src/
   ```
3. **Point frontend back to old backend** (update Vercel env var)
4. **Old deployment remains functional** during migration

## Support

For issues during migration:
1. Check Cloud Run logs: `gcloud run services logs read mineral-rights-api --region=us-central1`
2. Check Vercel deployment logs in dashboard
3. Verify all environment variables are set correctly
4. Test API endpoints individually

## Estimated Time

- Phase 1 (GCP Setup): 30-45 minutes
- Phase 2 (Config Updates): 15-20 minutes
- Phase 3 (Vercel Migration): 10-15 minutes
- Phase 4 (Anthropic): 5 minutes
- Phase 5 (Deploy): 10-15 minutes
- Phase 6 (Testing): 15-20 minutes

**Total: ~2 hours** (assuming no issues)

